name: Release

on:
  push:
    tags:
        - "v*.*.*"

jobs:
    pypi:
        name: Publish to PyPI
        runs-on: ubuntu-latest
        environment:
            name: pypi
            url: https://pypi.org/project/auto-rsa-bot/
        permissions:
            id-token: write
            contents: read
        steps:
          - name: Checkout
            uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
            with:
                submodules: recursive
          - name: Install uv
            uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7
          - name: Build
            run: uv build
          # Check that basic features work and we didn't miss to include crucial files
          - name: Smoke test (wheel)
            run: uv run --isolated --no-project --with dist/*.whl auto_rsa_bot --help
          - name: Smoke test (source distribution)
            run: uv run --isolated --no-project --with dist/*.tar.gz auto_rsa_bot --help
          - name: Publish
            run: uv publish
