name: Release

on:
  push:
    tags:
        - "v*.*.*"

jobs:
    pypi:
        name: Publish to PyPI
        runs-on: ubuntu-latest
        environment:
            name: pypi
            url: https://pypi.org/project/auto-rsa/
        permissions:
            id-token: write
            contents: read
        steps:
          - name: Checkout
            uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
          - name: Install uv
            uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7
          - name: Install Python 3.12
            run: uv python install 3.12
          - name: Build
            run: uv build
          # Check that basic features work and we didn't miss to include crucial files
          - name: Smoke test (wheel)
            run: uv run --isolated --no-project --with dist/*.whl auto_rsa_bot --help
          - name: Smoke test (source distribution)
            run: uv run --isolated --no-project --with dist/*.tar.gz auto_rsa_bot --help
          - name: Publish
            run: uv publish
